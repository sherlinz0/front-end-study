<!--
 * @Author: sherlyzz
 * @Date: 2022-01-30
 * @LastEditTime: 2022-01-30
 * @LastEditors: sherlyzz
 * @Description: 杂谈代码整洁的要素
-->

# 杂谈代码整洁

**概览**:

![概览](https://img-1305590520.cos.ap-shanghai.myqcloud.com/%E6%9D%82%E8%B0%88%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81-%E6%A6%82%E8%A7%88.png)

> Programs are meant to be read by humans and only incidentally for computers to execute. ——Donald Knuth
“代码始终是写给人看的, 只是恰好能被计算机执行.”

**好的代码**: 

- 局部干净
- 核心逻辑简洁

**指导原则**:

- 函数 与 类
- 包 与 模块 (依赖)
- 服务 (系统) 与 服务域
- 产品

在各个层面, 下文足以作一些指导或参考.

## 消除重复

### 代码重复

如果同一段代码出现两次及以上, 就应该抽取处函数

### 结构重复

代码虽不一样, 但结构类似, 也应该抽取. 结构重复可以推导出一些高级技术, 如:

- 继承体系
- 泛型
- 模板方法
- 高阶函数

### 过程重复

如果总是重复做一件事, 应该使其自动化.

## 分离关注点

### 分离主线和支线

在业务代码开发中, 应该突出主线, 淡化直线.

例如在下单的逻辑中, 可能的主线是: 检查库存, 检查余额, 生成订单. 那这个下单方法里就应该只有 3 行代码, 而不应该有诸如权限判断, 性能记录等, 如果出现就会有 2 行代码是跟主线无关的, 造成不必要的干扰, 不要造成无谓的心智负担, 应该解放心智去完成更复杂的事情.

分离主线和直线的技术有:

- `AOP` (面向切面编程)
- `interceptor` (拦截器), `filter` (过滤器)

### 分离技术和业务

技术型代码应该是公用的, 如日期计算, 日志记录, 性能测量, 数据库链接, 基础工具类. 这写应该和业务逻辑分开.

### 按业务性质分离

对于业务开发来说, 业务知识永远都是第一位. 即使一个程序员水平很高, 但是对业务不理解, 也不能发挥他的全部水平. 

不管是在 模块级别, 服务级, 甚至更高的 产品级 和 系统内部, 应该按业务分成不同的包, 同一业务下的对象是天然亲和的, 同样也是对不同业务的对象是隔离的.

### 分离变化快慢的代码

将变化快的代码和常年不变的代码分开.

### 分离性能高低的代码

重 I/O 的代码和重 CPU 的代码应该分开, 方便合理分配资源, 其他诸如此类的代码应该注意分开.

## 统一抽象层次

**两个原则**:

- 同一抽象层次上的对象才能直接对话
- 同一抽象层次上的对象之间存在紧密合作

## 隔离与隐藏

例如我们有一个包, 我们只提供数个 public 的方法, 包内的其他对象, 方法都只是包可见的, 这样, 我们可以随意修改内部实现, 只要保证那些 public 方法的行为不变.

## 编码 Tips

### 类

- 足够小
- 单一职责
- 内聚
- 信息隐蔽, 严格控制访问权限

### 函数

- 尽可能小
- 单一职责
- 单一抽象层次
- 参数尽量少
    
    - 减少参数
    - 连贯式接口

        ```javascript
        // bad
        assertEquals(expected, actual);
        // good 
        assertThat(actual).isEqualTo(expected);
        ```

- 无副作用

    - 无修改的 get 一个结果
    - 单纯修改, 不返回修改以外的结果

- if 嵌套不应超过 2 层

    消除多层 if 的手段:
    
    - 提前返回, 使不满足条件的分支提前返回
    - 碰到第三个 if, 直接将其抽取为函数 (简单粗暴)
    - `Lambda`, 在 `Java` 中利用 `stream` 的扁平化处理, 使 `filter`, `map` 等语法元素都可以接收简单的函数, 从而避免在 `for` 循环里加 `if` 判断. 对于集合的遍历处理, 都应该尽量先次啊用 stream 的做法.

- 语义 和 实现 距离不为 0 时应该抽取函数
- 童子军军规

    走的时候比来的时候干净一点.

- 任何时候都不应该在代码中直接出现 `hardcode`

### 命名与注释

- 顾名思义, 望文知意, 无歧义
- 名副其实
- 表达语义, 避免误导
    
    `users` 比 `userList` 好

- 谨慎使用缩写
- 团队统一业务术语
- 好的代码是自注释的

### 单元测试

单元测试有很多实践, 最著名的可能莫过于 `TDD` (测试驱动开发), 我们虽不至于按照 `TDD` 的实践来开发, 但我们应该善用单元测试.

好的函数, 单测一定是好写的.

**一些 Tips:**

- 使用 `mock` 对象
- 路径尽可能全
- 不能有条件分支
- 单测干净整洁
- `realBug` 测试是必要的

## 其他

### 心智负担

消除心智负担会在一定程度上意味着增加可读性和可维护性.

### 分层分包

**分层分包的本质就是隔离**。

分层的原则是只能上层调用下层, 而不能反过来，反之容易导致循环依赖, 分包的原则是, 同一个包中的对象天然是亲和的, 同时对包外的对象是不亲和 (隔离) 的.

### 设计原则

常见设计原则如下:

- SOLID
  
  - 单一职责
  - 开放封闭
  - 里氏替换
  - 接口隔离
  - 依赖倒置

- ADP 无环依赖
- REP 复用 / 发布等同
- CPP 共同封闭
- CRP 共同重用
- SDP 稳定依赖
- SAP 稳定抽象
- DRY 不重复
- KISS 解耦, 职责单一化
- YAGNI 不过度设计
- SLAP 单一抽象层次
- LoD 降低类的耦合度, 提高模块相对独立性

**深入参考 \<<Clean Code\>>**

**参考**

[1] **杂谈代码整洁** https://mp.weixin.qq.com/s/s_2dfOnMqND1qKjTfnmg5A
